//Author: Kaleb Sarlls

#include <AccelStepper.h> //Allows acceleration in bipolar steppers
#include <MultiStepper.h> //Allows the use of multiple steppers
#include <Adafruit_VL6180X.h>      // Z sensor library
#include <Wire.h>
#define stepPinZ 3
#define dirPinZ  2
#define stopPin 50

//Desired Z RPM = 266.67
//Z test
//   Pins:
//      - Enable = N/A
//      - Step = 3
//      - Direction = 2

bool notStoppedZ = true;
int buttonState = 0;
int clk = 0;
AccelStepper zMotor(1, stepPinZ, dirPinZ);
Adafruit_VL6180X tofZ = Adafruit_VL6180X();


void setup(){
  Serial.begin(9600);           //Serial monitoring
  zMotor.setMaxSpeed(500);      //Setting max speed for both to 500 for now
  pinMode(stopPin, INPUT);      //Emergency stop button
  pinMode(stepPinZ, OUTPUT);    //Setting the step/dir pins
  pinMode(dirPinZ, OUTPUT);  
  
  while (!Serial)               // makes sure TOF is connected
  {
  delay(1);
  }
  if (!tofZ.begin())
  {
    Serial.println(F("Failed to find VL6180X (ZMV)"));
    while(1);
  }
};


void loop() {
  float zDist = tofZ.readLux(VL6180X_ALS_GAIN_5);   // Z setup code
  Serial.print("zDist: ");                          // FIXME/TESTME: see what Lux is (also in TOF testing)
  Serial.println(zDist);
  uint8_t range = tofZ.readRange();
  uint8_t status = tofZ.readRangeStatus();

  if (status == VL6180X_ERROR_NONE) {          // detect and give Z distance
    Serial.print(""Distance in Z: ");
    Serial.println(range);
    //read the value of the emergency stop pin
  buttonState = digitalRead(stopPin);
  
  //FIXME: implement stepper to work with tof
  
  //Emergency stop clause
  if(buttonState==HIGH)
  {
    //Emergency stop serial monitor
    if(notStopped){
      //Print to serial monitor
      Serial.println();
      Serial.println("System Stopped.");
    }
    notStopped = false; //change bool flag
  }
  //If emergency stop has not been pressed
  
  //Two types of stepper control, comment out the one you want to use
  if(notStopped)
  {
    /* Library-based stepper control for z-motor
    z_testMotor.setCurrentPosition(0);
    z_testMotor.setSpeed(200);
    z_testMotor.runSpeed();
    if(z_testMotor.currentPosition() >= 400)
    {
      delay(10);
      z_testMotor.setCurrentPosition(0);
    }
    */
    
    
    
    
  }
};
